<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Call Test - Phase 2 WebRTC Implementation</title>

  <!-- UI Framework -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Toast notifications -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <!-- Socket.IO Client -->
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

  <!-- WebRTC Adapter for cross-browser compatibility -->
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .call-active {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    .audio-wave {
      display: inline-block;
      width: 4px;
      height: 20px;
      background: #10b981;
      margin: 0 1px;
      animation: wave 1s infinite ease-in-out;
    }

    .audio-wave:nth-child(2) {
      animation-delay: 0.1s;
    }

    .audio-wave:nth-child(3) {
      animation-delay: 0.2s;
    }

    .audio-wave:nth-child(4) {
      animation-delay: 0.3s;
    }

    .audio-wave:nth-child(5) {
      animation-delay: 0.4s;
    }

    @keyframes wave {

      0%,
      40%,
      100% {
        transform: scaleY(0.4);
      }

      20% {
        transform: scaleY(1);
      }
    }

    .hidden {
      display: none !important;
    }

    /* Video Container Styles - NEW Task 1.2 */
    .video-container {
      transition: all 0.3s ease;
    }

    .video-container.active {
      display: block !important;
    }

    .local-video-wrapper {
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .local-video-wrapper:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
    }

    .remote-video-wrapper {
      background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    }

    .local-video,
    .remote-video {
      transition: opacity 0.3s ease;
    }

    .control-btn {
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .control-btn:hover {
      transform: scale(1.1);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .video-call-controls {
      backdrop-filter: blur(15px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .connection-status {
      animation: connectionPulse 2s infinite;
    }

    @keyframes connectionPulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    /* Responsive video layout */
    @media (max-width: 768px) {
      .local-video-wrapper {
        width: 120px !important;
        height: 90px !important;
        top: 8px !important;
        right: 8px !important;
      }

      .video-call-controls {
        padding: 12px 16px !important;
        gap: 8px !important;
      }

      .control-btn {
        padding: 8px !important;
      }
    }
  </style>
</head>

<body class="gradient-bg min-h-screen">
  <!-- Header -->
  <header class="bg-white/10 backdrop-blur-lg border-b border-white/20">
    <div class="container mx-auto px-4 py-4">
      <h1 class="text-2xl font-bold text-white flex items-center">
        <i class="fas fa-phone-alt mr-3"></i>
        Voice Call Test - Phase 2 WebRTC
      </h1>
      <p class="text-white/80 mt-2">Testing WebRTC media stream integration vá»›i NestJS backend</p>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Configuration Panel -->
    <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 mb-6 border border-white/20">
      <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
        <i class="fas fa-cog mr-2"></i>
        Configuration & Authentication
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Server Configuration -->
        <div>
          <h3 class="text-white font-semibold mb-3">Server Configuration</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-white mb-2">Server URL</label>
              <input type="text" id="serverUrl"
                class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60"
                placeholder="http://localhost:3000" value="http://localhost:3000">
            </div>

            <button id="healthCheckBtn"
              class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
              <i class="fas fa-heartbeat mr-2"></i>
              Health Check
            </button>
          </div>
        </div>

        <!-- Authentication -->
        <div>
          <h3 class="text-white font-semibold mb-3">Authentication</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-white mb-2">Phone Number</label>
              <input type="text" id="phoneNumber"
                class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60"
                placeholder="+84901234567" value="+84901234567">
            </div>

            <div>
              <label class="block text-white mb-2">Password</label>
              <input type="password" id="password"
                class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60"
                placeholder="Test123!@#" value="Test123!@#">
            </div>

            <button id="loginBtn"
              class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
              <i class="fas fa-sign-in-alt mr-2"></i>
              Login & Connect
            </button>
          </div>
        </div>
      </div>

      <!-- Quick Test Users -->
      <div class="mt-4 p-4 bg-white/10 rounded-lg">
        <h4 class="text-white font-semibold mb-2">Quick Test Users:</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <button id="useTestUser1"
            class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm transition-colors">
            Use Test User 1 (+84901234567)
          </button>
          <button id="useTestUser2"
            class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm transition-colors">
            Use Test User 2 (+84901234001)
          </button>
        </div>
      </div>



      <div class="mt-4 flex gap-4">
        <button id="testMicBtn"
          class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors disabled:opacity-50"
          disabled>
          <i class="fas fa-microphone mr-2"></i>
          Test Microphone
        </button>

        <button id="disconnectBtn"
          class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors hidden">
          <i class="fas fa-sign-out-alt mr-2"></i>
          Disconnect
        </button>
      </div>
    </div>

    <!-- Connection Status & User Info -->
    <div class="bg-white/10 backdrop-blur-lg rounded-lg p-4 mb-6 border border-white/20">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div id="connectionStatus" class="w-3 h-3 rounded-full bg-red-500 mr-3"></div>
            <span class="text-white">Connection Status: </span>
            <span id="connectionText" class="text-white font-semibold ml-2">Disconnected</span>
          </div>

          <div class="flex items-center">
            <span class="text-white mr-2">WebRTC:</span>
            <div id="webrtcStatus" class="w-3 h-3 rounded-full bg-gray-500"></div>
          </div>
        </div>

        <div id="userInfo" class="hidden">
          <div class="flex items-center">
            <i class="fas fa-user-circle text-white mr-2"></i>
            <div>
              <div class="text-white font-semibold" id="userName">User Name</div>
              <div class="text-white/80 text-sm" id="userPhone">Phone Number</div>
              <div class="text-white/60 text-xs" id="userId">User ID</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Video Container Section - NEW Task 1.2 -->
    <div id="videoContainer"
      class="video-container hidden bg-black/90 backdrop-blur-lg rounded-lg mb-6 border border-white/20 overflow-hidden">
      <div class="relative w-full h-96 lg:h-[500px]">
        <!-- Remote Video (Other person) - Main display -->
        <div class="remote-video-wrapper w-full h-full relative bg-gray-900 flex items-center justify-center">
          <video id="remoteVideo" autoplay playsinline class="remote-video w-full h-full object-cover"></video>

          <!-- Remote user info overlay -->
          <div class="remote-info absolute top-4 left-4 bg-black/50 backdrop-blur-sm rounded-lg px-3 py-2">
            <span id="remoteUserName" class="text-white font-semibold">Remote User</span>
            <div id="remoteConnectionStatus" class="connection-status text-green-400 text-sm flex items-center">
              <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
              Connected
            </div>
          </div>

          <!-- Network quality indicator -->
          <div class="absolute top-4 right-4 bg-black/50 backdrop-blur-sm rounded-lg px-3 py-2">
            <div id="networkQuality" class="text-white text-xl" title="Network Quality">ðŸ“¶</div>
          </div>

          <!-- No video message -->
          <div id="noRemoteVideo" class="absolute inset-0 flex items-center justify-center bg-gray-800">
            <div class="text-center text-white">
              <i class="fas fa-video-slash text-4xl mb-2 opacity-50"></i>
              <p class="text-lg">Waiting for remote video...</p>
            </div>
          </div>
        </div>

        <!-- Local Video (Self) - Picture-in-Picture -->
        <div
          class="local-video-wrapper absolute top-4 right-20 w-48 h-36 bg-gray-800 rounded-lg overflow-hidden border-2 border-green-500 z-10">
          <video id="localVideo" autoplay muted playsinline class="local-video w-full h-full object-cover"></video>

          <!-- Video controls overlay -->
          <div class="video-controls-overlay absolute bottom-2 left-2 flex gap-1">
            <button id="switchCameraBtn"
              class="control-btn bg-black/70 hover:bg-black/90 text-white p-2 rounded-lg transition-colors"
              title="Switch Camera">
              <i class="fas fa-sync-alt text-sm"></i>
            </button>
            <button id="toggleVideoBtn"
              class="control-btn bg-black/70 hover:bg-black/90 text-white p-2 rounded-lg transition-colors"
              title="Toggle Video">
              <i class="fas fa-video text-sm"></i>
            </button>
          </div>

          <!-- Local video status -->
          <div class="absolute top-2 left-2 bg-black/70 rounded px-2 py-1">
            <span class="text-white text-xs">You</span>
          </div>
        </div>

        <!-- Video call action buttons -->
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2">
          <div id="videoCallControls"
            class="call-controls video-call-controls flex gap-3 bg-black/50 backdrop-blur-sm rounded-full px-6 py-3">
            <button id="muteAudioBtn"
              class="control-btn bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-full transition-colors"
              title="Toggle Mute">
              <i class="fas fa-microphone"></i>
            </button>
            <button id="toggleVideoBtn2"
              class="control-btn bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-full transition-colors"
              title="Toggle Video">
              <i class="fas fa-video"></i>
            </button>
            <button id="switchCameraBtn2"
              class="control-btn bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-full transition-colors"
              title="Switch Camera">
              <i class="fas fa-sync-alt"></i>
            </button>
            <button id="hangupVideoBtn"
              class="control-btn bg-red-600 hover:bg-red-700 text-white p-3 rounded-full transition-colors"
              title="End Call">
              <i class="fas fa-phone-slash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Voice Call Interface -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Call Controls -->
      <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 border border-white/20">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
          <i class="fas fa-phone mr-2"></i>
          Voice Call Controls
        </h3>

        <!-- Call Target -->
        <div class="mb-4">
          <label class="block text-white mb-2">Call To</label>
          <div class="space-y-2">
            <input type="text" id="targetUserId"
              class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60"
              placeholder="Enter User ID or Phone Number">

            <div class="text-xs text-white/60">
              Test User IDs: 6878adb69c41789577b3b9d1, 687895cb7dd3bd7b1960762d
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button type="button" id="callUser1"
                class="px-2 py-1 bg-white/20 hover:bg-white/30 text-white rounded text-xs transition-colors">
                Call Test User 1
              </button>
              <button type="button" id="callUser2"
                class="px-2 py-1 bg-white/20 hover:bg-white/30 text-white rounded text-xs transition-colors">
                Call Test User 2
              </button>
            </div>
          </div>
        </div>

        <!-- Call Buttons -->
        <div class="space-y-3">
          <!-- Call Type Selection -->
          <div class="grid grid-cols-2 gap-3">
            <button id="startCallBtn"
              class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center justify-center">
              <i class="fas fa-phone mr-2"></i>
              Voice Call
            </button>

            <button id="startVideoCallBtn"
              class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center">
              <i class="fas fa-video mr-2"></i>
              Video Call
            </button>
          </div>

          <!-- Camera Mode Selection for Video Calls -->
          <div id="cameraSelection" class="hidden bg-white/10 rounded-lg p-3">
            <label class="block text-white text-sm mb-2">Camera Settings:</label>
            <select id="cameraMode"
              class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white mb-3">
              <option value="user">Front Camera</option>
              <option value="environment">Back Camera</option>
            </select>

            <button id="testCameraBtn"
              class="w-full px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors text-sm">
              <i class="fas fa-camera mr-2"></i>
              Test Camera Access
            </button>
          </div>

          <button id="answerCallBtn"
            class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors hidden flex items-center justify-center">
            <i class="fas fa-phone-volume mr-2"></i>
            Answer Call
          </button>

          <div class="grid grid-cols-2 gap-3">
            <button id="muteBtn"
              class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors disabled:opacity-50">
              <i class="fas fa-microphone-slash mr-2"></i>
              Mute
            </button>

            <button id="speakerBtn"
              class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors disabled:opacity-50">
              <i class="fas fa-volume-up mr-2"></i>
              Speaker
            </button>
          </div>

          <button id="hangupBtn"
            class="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors hidden flex items-center justify-center">
            <i class="fas fa-phone-slash mr-2"></i>
            Hang Up
          </button>
        </div>
      </div>

      <!-- Call Status & Audio Visualization -->
      <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 border border-white/20">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
          <i class="fas fa-waveform-lines mr-2"></i>
          Call Status & Audio
        </h3>

        <!-- Current Call Info -->
        <div id="callInfo" class="hidden mb-6">
          <div class="bg-white/20 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-white">Call ID:</span>
              <span id="currentCallId" class="text-white font-mono text-sm"></span>
            </div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-white">Status:</span>
              <span id="callStatusText" class="text-white font-semibold"></span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-white">Duration:</span>
              <span id="callDuration" class="text-white font-mono">00:00</span>
            </div>
          </div>
        </div>

        <!-- Audio Visualization -->
        <div class="text-center mb-6">
          <div class="text-white mb-2">Local Audio Level</div>
          <div id="localAudioLevel" class="flex justify-center">
            <div class="audio-wave"></div>
            <div class="audio-wave"></div>
            <div class="audio-wave"></div>
            <div class="audio-wave"></div>
            <div class="audio-wave"></div>
          </div>
        </div>

        <div class="text-center">
          <div class="text-white mb-2">Remote Audio Level</div>
          <div id="remoteAudioLevel" class="flex justify-center">
            <div class="audio-wave bg-blue-500"></div>
            <div class="audio-wave bg-blue-500"></div>
            <div class="audio-wave bg-blue-500"></div>
            <div class="audio-wave bg-blue-500"></div>
            <div class="audio-wave bg-blue-500"></div>
          </div>
        </div>

        <!-- Audio Elements -->
        <audio id="localAudio" muted></audio>
        <audio id="remoteAudio" autoplay></audio>
      </div>
    </div>

    <!-- WebRTC Debug Info -->
    <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 mt-6 border border-white/20">
      <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
        <i class="fas fa-bug mr-2"></i>
        WebRTC Debug Information
      </h3>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <h4 class="text-white font-semibold mb-2">Local Description (SDP)</h4>
          <textarea id="localSdp" readonly
            class="w-full h-32 px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white text-xs font-mono resize-none"></textarea>
        </div>

        <div>
          <h4 class="text-white font-semibold mb-2">Remote Description (SDP)</h4>
          <textarea id="remoteSdp" readonly
            class="w-full h-32 px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white text-xs font-mono resize-none"></textarea>
        </div>
      </div>

      <div class="mt-4">
        <h4 class="text-white font-semibold mb-2">ICE Connection State</h4>
        <div class="flex items-center">
          <div id="iceState" class="px-3 py-1 bg-gray-600 text-white rounded-lg text-sm font-mono">new</div>
          <span class="text-white ml-3" id="iceStateDetails">ICE connection not started</span>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="bg-white/10 backdrop-blur-lg rounded-lg p-6 mt-6 border border-white/20">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white flex items-center">
          <i class="fas fa-terminal mr-2"></i>
          Event Logs
        </h3>
        <button id="clearLogsBtn"
          class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition-colors">
          Clear Logs
        </button>
      </div>

      <div id="logs"
        class="h-64 overflow-y-auto bg-black/50 rounded-lg p-4 font-mono text-sm text-green-400 border border-white/20">
        <div class="log-entry">[INFO] Voice Call Test Application initialized</div>
      </div>
    </div>
  </main>

  <!-- Incoming Call Modal -->
  <div id="incomingCallModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 text-center">
      <div class="mb-6">
        <i id="callTypeIcon" class="fas fa-phone-alt text-6xl text-blue-600 mb-4 call-active"></i>
        <h3 id="callTypeTitle" class="text-2xl font-bold text-gray-800 mb-2">Incoming Voice Call</h3>
        <p class="text-gray-600">From: <span id="callerInfo" class="font-semibold"></span></p>
        <p id="callTypeDescription" class="text-gray-500 text-sm mt-1">Voice call</p>
      </div>

      <div class="flex gap-4">
        <button id="declineCallBtn"
          class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
          <i class="fas fa-phone-slash mr-2"></i>
          Decline
        </button>

        <button id="acceptCallBtn"
          class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
          <i class="fas fa-phone mr-2"></i>
          Answer
        </button>
      </div>
    </div>
  </div>

  <!-- Authentication Service -->
  <script src="auth-service.js"></script>

  <!-- WebRTC Voice Call Service -->
  <script src="voice-call-service.js"></script>

  <!-- Main Application Script -->
  <script src="voice-call-app.js"></script>
</body>

</html>